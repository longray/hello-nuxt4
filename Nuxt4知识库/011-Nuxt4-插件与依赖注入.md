# Nuxt4 插件（Plugins）与依赖注入
标签: Nuxt4, 插件, 依赖注入, Plugins

## 问题描述
在 Nuxt4 应用中，我们经常需要注册全局组件、添加第三方库、注入全局变量或工具函数。如何优雅地组织和管理这些全局资源？如何确保它们在正确的时机被加载和初始化？

## 解决方案
Nuxt4 的插件系统提供了一种优雅的方式来扩展应用的功能。插件可以在应用启动时自动运行，可以注册全局组件、添加 Vue 指令、注入辅助函数等。

### 插件的类型
Nuxt4 插件根据其用途和运行环境可以分为几种类型：

1.  **全局插件**: 在所有环境（服务端和客户端）都会运行。
2.  **客户端插件**: 仅在浏览器中运行（文件名以 `.client.ts` 结尾）。
3.  **服务端插件**: 仅在服务器端运行（文件名以 `.server.ts` 结尾）。

### 创建插件
在项目根目录下创建 `plugins/` 文件夹，Nuxt 会自动加载这个目录下的所有插件文件。

#### 基础插件示例
`plugins/my-plugin.ts`:

```typescript
export default defineNuxtPlugin((nuxtApp) => {
  // 这里可以访问 nuxtApp 实例
  console.log('插件已加载！');

  return {
    provide: {
      // 注入可在模板中使用的工具函数
      sayHello: (name: string) => `你好，${name}！`,
      formatDate: (date: Date) => date.toLocaleDateString('zh-CN')
    }
  };
});
```

在模板中使用：
```vue
<template>
  <div>
    <!-- 通过 $ 访问注入的函数 -->
    <p>{{ $sayHello('小明') }}</p>
    <p>今天是 {{ $formatDate(new Date()) }}</p>
  </div>
</template>
```

#### 客户端专用插件
`plugins/toast.client.ts`:

```typescript
import Toast from 'vue-toastification';
import 'vue-toastification/dist/index.css';

export default defineNuxtPlugin((nuxtApp) => {
  // 只在客户端注册 Toast 插件
  nuxtApp.vueApp.use(Toast, {
    position: 'top-right',
    timeout: 3000,
    closeOnClick: true,
    pauseOnHover: true,
  });

  return {
    provide: {
      toast: (message: string) => {
        // 使用 Vue 的 getCurrentInstance 获取运行时上下文
        const { proxy } = getCurrentInstance()!;
        proxy.$toast(message);
      }
    }
  };
});
```

#### 服务端专用插件
`plugins/logger.server.ts`:

```typescript
import winston from 'winston';

export default defineNuxtPlugin(() => {
  const logger = winston.createLogger({
    level: 'info',
    format: winston.format.json(),
    transports: [
      new winston.transports.File({ filename: 'error.log', level: 'error' }),
      new winston.transports.File({ filename: 'combined.log' })
    ]
  });

  return {
    provide: {
      log: (level: string, message: string) => {
        logger.log(level, message);
      }
    }
  };
});
```

### 插件执行顺序
插件的执行顺序基于文件名的字母顺序。如果需要控制执行顺序，可以在文件名前加数字前缀：

```
plugins/
  ├── 1.global-setup.ts      # 首先执行
  ├── 2.api-client.ts        # 其次执行
  └── 3.ui-components.ts     # 最后执行
```

## 示例代码

### 示例 1: API 客户端插件

`plugins/api.ts`:
```typescript
import axios from 'axios';

export default defineNuxtPlugin((nuxtApp) => {
  const config = useRuntimeConfig();
  
  // 创建 axios 实例
  const api = axios.create({
    baseURL: config.public.apiBase,
    timeout: 10000,
    headers: {
      'Content-Type': 'application/json'
    }
  });

  // 请求拦截器
  api.interceptors.request.use((config) => {
    // 从 cookie 或 store 获取 token
    const token = useCookie('auth_token').value;
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  });

  // 响应拦截器
  api.interceptors.response.use(
    (response) => response.data,
    (error) => {
      // 统一错误处理
      if (error.response?.status === 401) {
        navigateTo('/login');
      }
      return Promise.reject(error);
    }
  );

  return {
    provide: {
      api: {
        get: (url: string, params?: any) => api.get(url, { params }),
        post: (url: string, data?: any) => api.post(url, data),
        put: (url: string, data?: any) => api.put(url, data),
        delete: (url: string) => api.delete(url)
      }
    }
  };
});
```

### 示例 2: UI 组件全局注册插件

`plugins/ui-components.ts`:
```typescript
import BaseButton from '~/components/base/Button.vue';
import BaseInput from '~/components/base/Input.vue';
import BaseCard from '~/components/base/Card.vue';

export default defineNuxtPlugin((nuxtApp) => {
  // 全局注册基础组件
  nuxtApp.vueApp.component('BaseButton', BaseButton);
  nuxtApp.vueApp.component('BaseInput', BaseInput);
  nuxtApp.vueApp.component('BaseCard', BaseCard);

  // 注册全局指令
  nuxtApp.vueApp.directive('focus', {
    mounted: (el) => el.focus()
  });

  // 注册全局 mixin（虽然在 Vue3 中不推荐使用）
  nuxtApp.vueApp.mixin({
    mounted() {
      console.log('组件已挂载');
    }
  });
});
```

## 常见坑点与注意事项

### 插件开发注意事项
-   **环境判断**: 使用 `process.client` 和 `process.server` 来区分运行环境，而不是检查 `window` 对象。
-   **异步操作**: 插件可以是异步的，但要注意处理好加载状态和错误情况。
-   **类型安全**: 为注入的属性和方法提供正确的 TypeScript 类型定义。
-   **命名冲突**: 注入的属性名不要与 Vue 或 Nuxt 的内置属性冲突。

### 依赖注入最佳实践
-   **命名规范**: 注入的属性使用 `$` 前缀，以区分于组件的本地属性。
-   **类型声明**: 在 `types/` 目录下为注入的属性声明类型：

```typescript
// types/index.d.ts
declare module '#app' {
  interface NuxtApp {
    $api: {
      get: (url: string, params?: any) => Promise<any>;
      post: (url: string, data?: any) => Promise<any>;
      // ...
    };
  }
}

export {};
```

### 常见错误
-   **循环依赖**: 插件之间相互依赖可能导致启动失败。确保插件之间的依赖关系是单向的。
-   **副作用管理**: 在插件中添加的全局事件监听器，记得在适当的时机清理。
-   **SSR 兼容性**: 确保插件在服务端和客户端都能正常工作，或使用 `.client`/`.server` 后缀明确区分。

## 参考链接
-   [Nuxt4 官方文档 - 插件](https://nuxt.com/docs/guide/directory-structure/plugins)
-   [Nuxt4 官方文档 - 运行时配置](https://nuxt.com/docs/guide/going-further/runtime-config)
-   [Vue3 官方文档 - 插件](https://vuejs.org/guide/reusability/plugins.html)