# Nuxt4 中间件（Middleware）与路由守卫
标签: Nuxt4, 中间件, 路由守卫, Middleware

## 问题描述
在开发 Web 应用时，我们经常需要在用户访问特定页面之前执行一些逻辑，例如检查用户是否登录、验证权限、或者重定向到其他页面。在 Nuxt4 中，如何优雅地实现这些“路由守卫”功能？

## 解决方案
Nuxt4 提供了一个强大的**中间件 (Middleware)** 系统，它允许你在路由导航发生之前执行代码。中间件是实现路由守卫、权限控制和页面重定向的核心机制。

### 中间件的类型
Nuxt4 中间件分为三种类型：

1.  **全局中间件**: 对每一次路由变化都会执行。定义在 `middleware/` 目录下，文件名会自动成为中间件名。
2.  **具名中间件 (路由中间件)**: 只有在被页面明确指定时才会执行。同样定义在 `middleware/` 目录下。
3.  **内联中间件**: 直接在页面组件内部定义的匿名中间件，只对该页面生效。

### 创建中间件
在项目根目录下创建 `middleware/` 文件夹。

-   `middleware/auth.ts` (一个具名中间件):

```typescript
// middleware/auth.ts
export default defineNuxtRouteMiddleware((to, from) => {
  const { isLoggedIn } = useUserStore(); // 假设你有一个 Pinia store

  // 如果用户未登录且试图访问非登录页面，则重定向到登录页
  if (!isLoggedIn && to.path !== '/login') {
    console.log('未登录，正在重定向...');
    return navigateTo('/login');
  }

  // 如果用户已登录且试图访问登录页，则重定向到首页
  if (isLoggedIn && to.path === '/login') {
    return navigateTo('/');
  }
});
```

-   `to`: 目标路由对象 (Route)。
-   `from`: 当前导航正要离开的路由对象。
-   `navigateTo()`: Nuxt 提供的用于程序化导航的辅助函数。

### 应用中间件

-   **全局应用**: 在 `nuxt.config.ts` 中配置，使其对所有页面生效。

    ```typescript
    // nuxt.config.ts
    export default defineNuxtConfig({
      router: {
        middleware: ['logger'] // 假设你有一个 middleware/logger.ts
      }
    })
    ```

-   **在页面中应用 (具名中间件)**: 使用 `definePageMeta` 宏。

    -   `pages/dashboard.vue`:

    ```vue
    <script setup>
    definePageMeta({
      middleware: 'auth' // 应用单个中间件
    });
    </script>
    ```

    -   `pages/admin.vue`:

    ```vue
    <script setup>
    definePageMeta({
      middleware: ['auth', 'admin-only'] // 应用多个中间件，按顺序执行
    });
    </script>
    ```

-   **在页面中应用 (内联中间件)**:

    ```vue
    <script setup>
    definePageMeta({
      middleware: function (to, from) {
        // 这是一个只对当前页面生效的内联中间件
        if (to.params.id === 'forbidden') {
          return abortNavigation('你无权访问此页面'); // 阻止导航并显示错误
        }
      }
    });
    </script>
    ```

## 示例代码

### 示例 1: 日志记录中间件 (全局)

`middleware/logger.global.ts`: (添加 `.global` 后缀使其自动成为全局中间件)

```typescript
export default defineNuxtRouteMiddleware((to, from) => {
  console.log(`[路由日志] 从: ${from.fullPath} -> 到: ${to.fullPath}`);
  if (process.server) {
    console.log('这次导航发生在服务端');
  } else {
    console.log('这次导航发生在客户端');
  }
});
```

### 示例 2: 权限验证中间件 (具名)

`middleware/permission.ts`:

```typescript
import { useUserStore } from '~/stores/user';

export default defineNuxtRouteMiddleware((to, from) => {
  const userStore = useUserStore();

  // 检查页面是否需要特定权限
  const requiredPermission = to.meta.permission as string;

  if (requiredPermission && !userStore.hasPermission(requiredPermission)) {
    // 如果用户没有所需权限，显示一个错误页面
    return abortNavigation({
      statusCode: 403,
      message: '你没有权限访问此页面'
    });
  }
});
```

在页面中使用:

`pages/settings.vue`:

```vue
<script setup>
definePageMeta({
  middleware: ['auth', 'permission'],
  // 在 meta 中定义此页面需要的权限
  permission: 'edit-settings'
});
</script>
```

## 常见坑点与注意事项
-   **执行顺序**: 全局中间件首先执行，然后是布局中间件，最后是页面中间件。在数组中指定的多个中间件会按顺序依次执行。
-   **异步中间件**: 中间件可以是异步的 (`async`)。Nuxt 会等待异步中间件的 Promise 解析完毕后才继续导航。
-   **重定向 vs 阻止导航**: `navigateTo()` 用于重定向到新页面，而 `abortNavigation()` 用于完全取消当前的导航并可以选择性地显示一个错误信息。
-   **服务端 vs 客户端**: 中间件在服务端首次访问时运行一次，之后在客户端的每次导航时都会运行。使用 `process.server` 和 `process.client` 来区分执行环境。
-   **命名约定**: 中间件的文件名（不含扩展名）就是它的名称，采用 kebab-case 格式。例如 `checkAuth.ts` 对应中间件 `check-auth`。

## 参考链接
-   [Nuxt4 官方文档 - 中间件](https://nuxt.com/docs/guide/directory-structure/middleware)
-   [Nuxt4 官方文档 - `navigateTo` 辅助函数](https://nuxt.com/docs/api/utils/navigate-to)
-   [Nuxt4 官方文档 - `abortNavigation` 辅助函数](https://nuxt.com/docs/api/utils/abort-navigation)