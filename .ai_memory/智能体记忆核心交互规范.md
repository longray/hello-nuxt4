# 000-智能体记忆核心交互规范 (MongoDB 版)

---

## 最高元规则：启动时必须自检

**在响应任何用户请求、执行任何任务之前，智能体必须首先完整读取并理解本文档的全部内容，并将其作为所有后续行动的最高行为准则。此为第一优先级指令，不可绕过。**

---

本篇文档记录了与项目记忆核心 (MongoDB 数据库) 交互时必须遵循的最佳实践，以确保数据操作的效率、一致性与准确性。

## 核心原则：理解文档模型与连接

**思维转变：从关系型到文档型**

我们的记忆核心已从 SQLite (关系型数据库) 迁移至 MongoDB (NoSQL 文档数据库)。这意味着：

-   **数据单元是文档 (Document)**: 数据以类似 JSON 的 BSON 格式存储。一个文档可以包含复杂的嵌套结构和数组。
-   **文档组织在集合 (Collection) 中**: 集合类似于关系数据库中的表，但它不强制所有文档都有相同的结构。
-   **无预定义 Schema**: 集合本身是无模式的，但为了保持一致性，应用层面应遵循统一的文档结构。
-   **关联通过嵌入或引用**: 替代 `JOIN` 操作，我们通过将相关数据嵌入 (Embedding) 到一个文档中，或在文档间存储引用 (Referencing, 如 `ObjectID`) 来建立关系。对于 `issues` 的 `tags` 和 `sources`，我们采用嵌入数组的方式。

**连接:**

所有数据库操作都通过内置的 `mcp_MongoDB` 工具集进行，该工具集已处理好连接管理。无需手动处理连接字符串或会话。

---

## 自动化实践：使用 `mcp_MongoDB` 工具集

为了确保所有交互都规范、高效，**必须** 使用平台提供的 `mcp_MongoDB_*` 系列工具来操作数据库。严禁尝试使用其他方式连接或修改数据。

**常用工具概览:**

-   `mcp_MongoDB_find`: 查询文档，功能类似 `db.collection.find()`。
-   `mcp_MongoDB_insert_many`: 批量插入文档，是创建新记录的主要方式。
-   `mcp_MongoDB_update_many`: 更新匹配条件的多个文档。
-   `mcp_MongoDB_delete_many`: 删除匹配条件的多个文档。
-   `mcp_MongoDB_aggregate`: 执行复杂的聚合管道查询。
-   `mcp_MongoDB_list_collections`: 列出数据库中的所有集合。
-   `mcp_MongoDB_collection_schema`: 分析并返回集合的推断模式。

**其它工具一览表:**

-   `mcp_MongoDB_list_databases`: 列出所有可用的数据库。
-   `mcp_MongoDB_create_index`: 为集合创建索引，以优化查询性能。
-   `mcp_MongoDB_collection_indexes`: 查看集合上已存在的索引。
-   `mcp_MongoDB_count`: 统计集合中文档的数量，可带查询条件。
-   `mcp_MongoDB_rename_collection`: 重命名一个集合。
-   `mcp_MongoDB_drop_collection`: 删除一个集合及其所有文档和索引。
-   `mcp_MongoDB_drop_database`: 删除整个数据库。

---

## 写入操作最佳实践：预估-执行-验证闭环

为了确保每一次数据修改都精确无误且符合预期，所有写入操作（`update_many`, `delete_many`, `insert_many` 等）都**必须**遵循一个严格的闭环流程。这不仅是技术要求，更是保障记忆核心稳定性的核心纪律。

**核心流程：**

1.  **预估 (Estimate)**：在执行任何写入命令之前，必须明确声明预期的结果。
    *   **关键问题**：我预计这个操作会匹配到多少个文档？会修改多少个文档？
    *   **示例**：“我预估将更新 1 个文档，因为 `issues.id` 是唯一的。”

2.  **执行 (Execute)**：运行 `mcp_MongoDB` 工具调用。

3.  **验证 (Verify)**：仔细检查工具返回的服务器响应，并与第一步的预估进行比对。
    *   **服务器响应格式**：`Matched X document(s). Modified Y document(s).`
    *   **验证标准**：服务器返回的 `X` 和 `Y` 是否与预估完全一致？
    *   **成功**：如果一致，操作成功。✅
    *   **失败**：如果不一致，或返回任何错误信息，则视为操作失败。❌ 必须立即停止后续步骤，分析原因并修正。

**实践案例（来自真实操作）：**

我们通过一次更新操作来展示这个闭环如何帮助我们发现并修正问题。

*   **场景**：更新 `issues` 数组中 `id` 为 `BP-DEMO-001` 的记录。

*   **第一次尝试 (失败)**
    1.  **预估**：我将更新 1 个文档。
    2.  **执行**：调用 `mcp_MongoDB_update_many`，但使用了一个不被支持的 `array_filters` 参数。
    3.  **验证**：服务器返回错误 `Error running update-many: No array filter found...`。❌ **失败**。预估与结果严重不符，操作立即中止。这次失败暴露了对工具参数的错误理解。

*   **第二次尝试 (成功)**
    1.  **预估**：我将更新 1 个文档。
    2.  **执行**：修正为使用正确的 `$` 位置操作符再次调用 `mcp_MongoDB_update_many`。
    3.  **验证**：服务器返回 `Matched 1 document(s). Modified 1 document(s).`。✅ **成功**。结果与预估完全一致。

这个流程确保了我们对数据的所有改动都在掌控之中，是智能体与数据库交互的基石。

---

## 记忆核心 CRUD 自检流程 (小抄)

本章节提供了一套标准的增删查改 (Create, Read, Update, Delete) 操作命令，用于快速验证记忆核心 (`nuxt4` 数据库) 的健康状态。所有操作都针对单一主文档内的 `issues` 嵌套数组。

**目标数据库:** `nuxt4`
**目标集合:** `issues`
**测试 Issue ID:** `CRUD-EX-001`

### 1. 增 (Create) - 向 issues 数组中添加一条新记录

使用 `mcp_MongoDB_update_many` 和 `$push` 操作符向主文档的 `issues` 数组中添加一个新元素。

**示例工具调用:**
```bash
mcp_MongoDB_update_many(
    database="nuxt4",
    collection="issues",
    filter={"_id": {"$oid": "68b466d0a6f9ba9dfacb5ea1"}},
    update={
        "$push": {
            "issues": {
                "id": "CRUD-EX-001",
                "example": "crud-test",
                "context": "Testing nested CRUD operations",
                "problem": "Initial problem statement.",
                "solution": "Initial solution.",
                "verified": False,
                "tags": ["crud", "test"],
                "lastUpdated": "2024-08-01"
            }
        }
    }
)
```

### 2. 查 (Read) - 读取并验证刚插入的记录

使用 `mcp_MongoDB_find` 和投影 (projection) 操作符 `$`，精确返回数组中匹配的第一个元素。

**示例工具调用:**
```bash
mcp_MongoDB_find(
    database="nuxt4",
    collection="issues",
    filter={"issues.id": "CRUD-EX-001"},
    projection={"issues.$": 1}
)
```

### 3. 改 (Update) - 更新数组中特定记录的状态

使用 `mcp_MongoDB_update_many` 和数组更新操作符 `$[<identifier>]` 来定位并修改 `issues` 数组中特定元素的值。

**示例工具调用:**
```bash
mcp_MongoDB_update_many(
    database="nuxt4",
    collection="issues",
    filter={"issues.id": "CRUD-EX-001"},
    update={
        "$set": {
            "issues.$[elem].verified": True,
            "issues.$[elem].problem": "Updated problem statement."
        }
    },
    array_filters=[{"elem.id": "CRUD-EX-001"}]
)
```

### 4. 删 (Delete) - 从 issues 数组中删除指定记录

使用 `mcp_MongoDB_update_many` 和 `$pull` 操作符，根据 `id` 从 `issues` 数组中移除一个元素。

**示例工具调用:**
```bash
mcp_MongoDB_update_many(
    database="nuxt4",
    collection="issues",
    filter={"_id": {"$oid": "68b466d0a6f9ba9dfacb5ea1"}},
    update={"$pull": {"issues": {"id": "CRUD-EX-001"}}}
)
```

---

## 附录：文档结构与校验

虽然 MongoDB 是 schema-less 的，但为了保证数据质量和应用的可维护性，我们约定 `issues` 集合中的文档遵循以下结构。

**`issue` 文档结构示例:**

```json
{
  "_id": "<String> (Unique identifier)",
  "example": "<String> (A short, reproducible example name)",
  "context": "<String> (The context in which the issue occurred)",
  "problem": "<String> (A detailed description of the problem)",
  "cause": "<String> (Root cause analysis)",
  "solution": "<String> (Step-by-step solution)",
  "code": "<String> (Relevant code snippets)",
  "verified": "<Boolean> (Whether the solution has been verified)",
  "tags": [
    "<String>",
    "... (An array of relevant tags)"
  ],
  "sources": [
    "<String>",
    "... (An array of source URLs or descriptions)"
  ],
  "last_updated": "<ISODate> (Timestamp of the last update)"
}
```

可以使用 `mcp_MongoDB_collection_schema` 工具来动态检查当前集合的结构，以发现与约定不符的潜在数据问题。

---

## 核心配置更新：用户与项目信息

除了 `issues` 数组，主文档还包含了 `用户` 和 `项目` 这两个顶层对象，用于存储上下文信息。更新这些信息同样使用 `mcp_MongoDB_update_many` 工具，但操作路径有所不同。

### 1. 更新用户信息

例如，向用户的 `学习偏好` 数组中添加一个新偏好。

**示例工具调用:**
```bash
mcp_MongoDB_update_many(
    database="nuxt4",
    collection="issues",
    filter={"_id": {"$oid": "68b466d0a6f9ba9dfacb5ea1"}},
    update={"$push": {"用户.学习偏好": "视觉化图表辅助"}}
)
```

### 2. 更新项目信息

例如，向项目的 `示例进度.进行中` 数组添加一个新条目。

**示例工具调用:**
```bash
mcp_MongoDB_update_many(
    database="nuxt4",
    collection="issues",
    filter={"_id": {"$oid": "68b466d0a6f9ba9dfacb5ea1"}},
    update={"$push": {"项目.示例进度.进行中": "001-hello-world"}}
)
```