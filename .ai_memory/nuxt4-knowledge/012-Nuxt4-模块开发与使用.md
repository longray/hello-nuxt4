# Nuxt4 æ¨¡å—ï¼ˆModulesï¼‰å¼€å‘ä¸ä½¿ç”¨
æ ‡ç­¾: Nuxt4, æ¨¡å—, Modules, æ‰©å±•

## é—®é¢˜æè¿°
Nuxt4 çš„æ¨¡å—ç³»ç»Ÿæ˜¯å…¶æœ€å¼ºå¤§çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒå…è®¸æˆ‘ä»¬ä»¥ä¸€ç§å¯é‡ç”¨ã€å¯é…ç½®çš„æ–¹å¼æ‰©å±• Nuxt çš„æ ¸å¿ƒåŠŸèƒ½ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•æ­£ç¡®åœ°ä½¿ç”¨ç°æœ‰æ¨¡å—ï¼Ÿå¦‚ä½•å¼€å‘è‡ªå·±çš„æ¨¡å—ï¼Ÿå¦‚ä½•ç¡®ä¿æ¨¡å—çš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ï¼Ÿ

## è§£å†³æ–¹æ¡ˆ
Nuxt4 æ¨¡å—æ˜¯ä¸€ç§å¼ºå¤§çš„æ–¹å¼æ¥æ‰©å±•æ¡†æ¶çš„åŠŸèƒ½ï¼Œå¯ä»¥ç”¨æ¥æ·»åŠ é›†æˆã€è‡ªå®šä¹‰æ„å»ºé€»è¾‘ã€æ³¨å…¥å˜é‡ï¼Œç”šè‡³ä¿®æ”¹ Nuxt çš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚

### ä½¿ç”¨ç°æœ‰æ¨¡å—

#### å®‰è£…å’Œé…ç½®
1.  é€šè¿‡ npm å®‰è£…æ¨¡å—ï¼š
```bash
# å®‰è£… TailwindCSS æ¨¡å—
npm install @nuxtjs/tailwindcss

# å®‰è£… Image æ¨¡å—
npm install @nuxt/image
```

2.  åœ¨ `nuxt.config.ts` ä¸­æ³¨å†Œæ¨¡å—ï¼š
```typescript
export default defineNuxtConfig({
  modules: [
    '@nuxtjs/tailwindcss',
    '@nuxt/image',
    // å¸¦é…ç½®çš„æ¨¡å—
    ['@pinia/nuxt', {
      autoImports: ['defineStore', 'storeToRefs']
    }]
  ]
})
```

### å¼€å‘è‡ªå®šä¹‰æ¨¡å—

#### åŸºç¡€æ¨¡å—ç»“æ„
ä¸€ä¸ªæœ€åŸºæœ¬çš„ Nuxt æ¨¡å—æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥æ”¶ `options` å’Œ `nuxt` å®ä¾‹ä½œä¸ºå‚æ•°ï¼š

```typescript
// modules/my-module/index.ts
import { defineNuxtModule } from '@nuxt/kit'

export default defineNuxtModule({
  meta: {
    name: 'my-module',
    configKey: 'myModule',
    compatibility: {
      nuxt: '^4.0.0'
    }
  },
  defaults: {
    // æ¨¡å—çš„é»˜è®¤é…ç½®
    addPlugin: true,
    prefix: 'awesome'
  },
  setup(options, nuxt) {
    // æ¨¡å—çš„è®¾ç½®é€»è¾‘
    if (options.addPlugin) {
      // æ·»åŠ æ’ä»¶
      addPlugin(resolve('./runtime/plugin'))
    }

    // æ·»åŠ è‡ªåŠ¨å¯¼å…¥
    nuxt.hook('imports:dirs', (dirs) => {
      dirs.push(resolve('./runtime/composables'))
    })

    // æ‰©å±•æ„å»ºé…ç½®
    nuxt.hook('webpack:config', (config) => {
      // ä¿®æ”¹ webpack é…ç½®
    })
  }
})
```

## ç¤ºä¾‹ä»£ç 

### ç¤ºä¾‹ 1: å¼€å‘ä¸€ä¸ªç®€å•çš„ Analytics æ¨¡å—

```typescript
// modules/analytics/index.ts
import { defineNuxtModule, addPlugin, createResolver } from '@nuxt/kit'
import { defu } from 'defu'

export interface ModuleOptions {
  id: string
  debug?: boolean
  disabled?: boolean
}

export default defineNuxtModule<ModuleOptions>({
  meta: {
    name: 'analytics',
    configKey: 'analytics',
    compatibility: {
      nuxt: '^4.0.0'
    }
  },
  defaults: {
    id: '',
    debug: false,
    disabled: false
  },
  setup(options, nuxt) {
    if (!options.id) {
      throw new Error('Analytics ID is required!')
    }

    // åˆ›å»ºè§£æå™¨æ¥å¤„ç†ç›¸å¯¹è·¯å¾„
    const resolver = createResolver(import.meta.url)

    // å°†é€‰é¡¹æš´éœ²ç»™è¿è¡Œæ—¶é…ç½®
    nuxt.options.runtimeConfig.public.analytics = defu(
      nuxt.options.runtimeConfig.public.analytics,
      {
        id: options.id,
        debug: options.debug
      }
    )

    // æ·»åŠ æ’ä»¶
    if (!options.disabled) {
      addPlugin(resolver.resolve('./runtime/plugin'))
    }

    // æ·»åŠ æ„å»ºæ—¶çš„è½¬æ¢
    nuxt.hook('nitro:config', (nitroConfig) => {
      nitroConfig.externals = nitroConfig.externals || {}
      nitroConfig.externals.inline = nitroConfig.externals.inline || []
      nitroConfig.externals.inline.push(resolver.resolve('./runtime'))
    })

    // æ·»åŠ ç±»å‹å£°æ˜
    nuxt.hook('prepare:types', (options) => {
      options.references.push({
        path: resolver.resolve('./types/index.d.ts')
      })
    })
  }
})

// modules/analytics/runtime/plugin.ts
export default defineNuxtPlugin((nuxtApp) => {
  const config = useRuntimeConfig()
  const analytics = config.public.analytics

  // åœ¨å®¢æˆ·ç«¯åˆå§‹åŒ– analytics
  if (process.client) {
    // åŠ è½½ analytics è„šæœ¬
    const script = document.createElement('script')
    script.src = `https://analytics.example.com/${analytics.id}.js`
    document.head.appendChild(script)

    // æä¾›è·Ÿè¸ªæ–¹æ³•
    return {
      provide: {
        track: (event: string, data?: any) => {
          if (analytics.debug) {
            console.log('è·Ÿè¸ªäº‹ä»¶:', event, data)
          }
          // å®é™…çš„è·Ÿè¸ªé€»è¾‘
        }
      }
    }
  }
})
```

### ç¤ºä¾‹ 2: å¼€å‘ä¸€ä¸ªè‡ªåŠ¨ API æ–‡æ¡£ç”Ÿæˆæ¨¡å—

```typescript
// modules/api-docs/index.ts
import { defineNuxtModule, addServerHandler } from '@nuxt/kit'
import { resolve } from 'path'
import * as fs from 'fs'

export interface ModuleOptions {
  path: string
  title: string
  version: string
}

export default defineNuxtModule<ModuleOptions>({
  meta: {
    name: 'api-docs',
    configKey: 'apiDocs'
  },
  defaults: {
    path: '/api-docs',
    title: 'API Documentation',
    version: '1.0.0'
  },
  setup(options, nuxt) {
    // åˆ›å»º API æ–‡æ¡£è·¯ç”±
    addServerHandler({
      route: options.path,
      handler: resolve(__dirname, './runtime/api-docs')
    })

    // æ”¶é›† API è·¯ç”±ä¿¡æ¯
    nuxt.hook('pages:extend', (pages) => {
      const apiRoutes = pages.filter(page => page.path.startsWith('/api/'))
      
      // ç”Ÿæˆæ–‡æ¡£æ•°æ®
      const docs = apiRoutes.map(route => ({
        path: route.path,
        method: route.meta?.method || 'GET',
        description: route.meta?.description
      }))

      // ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
      fs.writeFileSync(
        resolve(nuxt.options.buildDir, 'api-docs.json'),
        JSON.stringify(docs, null, 2)
      )
    })

    // æ·»åŠ å¼€å‘å·¥å…·é¢æ¿
    if (nuxt.options.dev) {
      nuxt.hook('devtools:customTabs', (tabs) => {
        tabs.push({
          name: 'api-docs',
          title: 'API Docs',
          icon: 'ğŸ“š',
          view: {
            type: 'iframe',
            src: options.path
          }
        })
      })
    }
  }
})
```

## å¸¸è§å‘ç‚¹ä¸æ³¨æ„äº‹é¡¹

### æ¨¡å—å¼€å‘æ³¨æ„äº‹é¡¹
-   **ç”Ÿå‘½å‘¨æœŸ**: ç†è§£ Nuxt çš„æ¨¡å—ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„æ—¶æœºæ‰§è¡Œæ“ä½œã€‚
-   **ç±»å‹å®‰å…¨**: ä½¿ç”¨ TypeScript å¹¶ä¸ºæ¨¡å—é€‰é¡¹æä¾›ç±»å‹å®šä¹‰ã€‚
-   **æ€§èƒ½å½±å“**: æ¨¡å—çš„è®¾ç½®é€»è¾‘åœ¨æ„å»ºæ—¶æ‰§è¡Œï¼Œåº”è¯¥å°½å¯èƒ½é«˜æ•ˆã€‚
-   **ä¾èµ–ç®¡ç†**: æ˜ç¡®å£°æ˜æ¨¡å—çš„ä¾èµ–ï¼Œå¹¶å¤„ç†å¥½ç‰ˆæœ¬å…¼å®¹æ€§ã€‚

### å¸¸è§é”™è¯¯
-   **é’©å­ä½¿ç”¨**: ç¡®ä¿åœ¨æ­£ç¡®çš„é’©å­ä¸­æ‰§è¡Œæ“ä½œï¼Œä¾‹å¦‚ä¸è¦åœ¨æ„å»ºé’©å­ä¸­è®¿é—®è¿è¡Œæ—¶æ•°æ®ã€‚
-   **è·¯å¾„è§£æ**: ä½¿ç”¨ `createResolver` æ¥æ­£ç¡®å¤„ç†æ¨¡å—å†…çš„æ–‡ä»¶è·¯å¾„ã€‚
-   **é…ç½®åˆå¹¶**: ä½¿ç”¨ `defu` ç­‰å·¥å…·æ¥æ­£ç¡®åˆå¹¶é…ç½®å¯¹è±¡ï¼Œé¿å…è¦†ç›–ç”¨æˆ·é…ç½®ã€‚

### æœ€ä½³å®è·µ
-   **æ¨¡å—å‘½å**: éµå¾ª `nuxt-*` æˆ– `@org/nuxt-*` çš„å‘½åçº¦å®šã€‚
-   **æ–‡æ¡£**: æä¾›æ¸…æ™°çš„æ–‡æ¡£ï¼ŒåŒ…æ‹¬å®‰è£…ã€é…ç½®é€‰é¡¹å’Œä½¿ç”¨ç¤ºä¾‹ã€‚
-   **æµ‹è¯•**: ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œç¡®ä¿æ¨¡å—åœ¨ä¸åŒç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œã€‚
-   **ç‰ˆæœ¬æ§åˆ¶**: éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ï¼Œæ˜ç¡®è®°å½•å˜æ›´ã€‚

### å‘å¸ƒæ£€æŸ¥æ¸…å•
1.  ç¡®ä¿ `package.json` ä¸­åŒ…å«æ­£ç¡®çš„ä¿¡æ¯ï¼š
    ```json
    {
      "name": "nuxt-my-module",
      "version": "1.0.0",
      "type": "module",
      "main": "./dist/module.mjs",
      "types": "./dist/types.d.ts",
      "files": [
        "dist"
      ],
      "peerDependencies": {
        "nuxt": "^4.0.0"
      }
    }
    ```

2.  åŒ…å«å¿…è¦çš„æ–‡ä»¶ï¼š
    -   README.md
    -   LICENSE
    -   CHANGELOG.md
    -   types/index.d.ts

3.  è®¾ç½®æ­£ç¡®çš„ npm å‘å¸ƒé…ç½®ï¼š
    ```
    .npmignore
    .gitignore
    ```

## å‚è€ƒé“¾æ¥
-   [Nuxt4 å®˜æ–¹æ–‡æ¡£ - æ¨¡å—å¼€å‘](https://nuxt.com/docs/guide/going-further/modules)
-   [Nuxt4 æ¨¡å—åˆ—è¡¨](https://nuxt.com/modules)
-   [Nuxt Kit æ–‡æ¡£](https://nuxt.com/docs/guide/going-further/kit)