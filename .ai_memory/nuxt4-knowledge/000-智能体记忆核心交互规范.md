# 000-智能体记忆核心交互规范

本篇文档记录了与项目记忆核心 (`memory.db`) 交互时必须遵循的最佳实践，以确保数据的完整性与一致性。

## 核心原则：始终开启外键约束

**问题 (Problem):**

在 SQLite 3.6.19 之前的版本，以及 `sqlite3` 命令行工具的默认设置中，外键约束 (`FOREIGN KEY constraints`) 是默认关闭的。

这意味着，即使表结构中定义了 `ON DELETE CASCADE` 级联删除规则，当从主表删除一条记录时，关联子表中的记录 **不会** 被自动删除，从而产生孤儿数据 (Orphaned Data)，破坏了记忆核心的完整性。

**根源 (Cause):**

这是 SQLite 为了向后兼容而做出的设计选择。

**解决方案 (Solution):**

在执行任何可能触发外键约束的操作（如 `DELETE`, `UPDATE`）之前，必须在 **同一个数据库连接会话** 中，首先执行以下命令来显式开启外键约束：

```sql
PRAGMA foreign_keys = ON;
```

---

## 自动化实践：使用封装脚本

为了从根本上杜绝忘记开启外键约束的风险，我们引入了一个封装脚本 `000-记忆核心交互脚本.ps1`。

**目的:**

所有助理在与 `memory.db` 进行交互时，**必须** 使用此脚本，而不是直接调用 `sqlite3`。

**工作原理:**

该脚本会自动在执行你传入的 SQL 语句之前，先执行 `PRAGMA foreign_keys = ON;`，从而确保外键约束始终处于激活状态。

**使用方法:**

```powershell
# 示例：使用封装脚本删除一条 issue 记录
./.ai_memory/run-sql.ps1 "DELETE FROM issues WHERE id = 'some-id';"
```

通过强制使用此脚本，我们将规则固化为了代码，确保了记忆核心的长期健康。

---

## 记忆核心 CRUD 自检流程 (小抄)

本章节提供了一套标准的增删查改 (Create, Read, Update, Delete) 操作命令，用于快速验证记忆核心 (`memory.db`) 的健康状态。所有操作都应通过 `000-记忆核心交互脚本.ps1` 执行。

**测试数据ID:** `test-crud-001`

### 1. 增 (Create) - 插入一条完整的测试记录

```powershell
# 使用 .\000-记忆核心交互脚本.ps1 执行
.\.ai_memory\nuxt4-knowledge\000-记忆核心交互脚本.ps1 "INSERT INTO issues (id, example, context, problem, cause, solution, code, verified, last_updated) VALUES ('test-crud-001', 'self-check', 'CRUD-test', 'Problem description', 'Cause analysis', 'Solution steps', 'console.log("hello world")', 0, DATE('now')); INSERT INTO issue_tags (issue_id, tag) VALUES ('test-crud-001', 'test-tag-1'), ('test-crud-001', 'test-tag-2'); INSERT INTO issue_sources (issue_id, source) VALUES ('test-crud-001', 'internal-test');"
```

### 2. 查 (Read) - 读取并验证插入的记录

```powershell
# 查询主表
.\.ai_memory\nuxt4-knowledge\000-记忆核心交互脚本.ps1 "SELECT * FROM issues WHERE id = 'test-crud-001';"

# 查询关联表
.\.ai_memory\nuxt4-knowledge\000-记忆核心交互脚本.ps1 "SELECT * FROM issue_tags WHERE issue_id = 'test-crud-001'; SELECT * FROM issue_sources WHERE issue_id = 'test-crud-001';"
```

### 3. 改 (Update) - 更新记录并验证

```powershell
# 更新 verified 状态为 true
.\.ai_memory\nuxt4-knowledge\000-记忆核心交互脚本.ps1 "UPDATE issues SET verified = 1, problem = 'Problem description (updated)' WHERE id = 'test-crud-001';"

# 验证更新结果
.\.ai_memory\nuxt4-knowledge\000-记忆核心交互脚本.ps1 "SELECT id, problem, verified FROM issues WHERE id = 'test-crud-001';"
```

### 4. 删 (Delete) - 删除主记录并验证级联删除

```powershell
# 删除主记录
.\.ai_memory\nuxt4-knowledge\000-记忆核心交互脚本.ps1 "DELETE FROM issues WHERE id = 'test-crud-001';"

# 验证所有相关记录（主表和关联表）均已被删除
.\.ai_memory\nuxt4-knowledge\000-记忆核心交互脚本.ps1 "SELECT * FROM issues WHERE id = 'test-crud-001'; SELECT * FROM issue_tags WHERE issue_id = 'test-crud-001'; SELECT * FROM issue_sources WHERE issue_id = 'test-crud-001';"
```